{% extends "course_base.html" %}
{% load url from future %}

{% block m_column_content %}
{% autoescape off %}

{% if common_page_data.course.mode == "ready" and not exam.is_live %}

    This exam will go live on {{ exam.live_datetime }} PDT.

{% elif common_page_data.course.mode == "ready" and exam.past_due %}

    This exam was closed on {{ exam.due_date }} PDT.

{% else %}

    <noscript>
    <div class="alert alert-error">Your browser does not have JavaScript enabled. Please enable it before taking this exam</div>
    </noscript>
    {{ exam.html_content }}

{% endif %}

{% endautoescape %}
{% endblock m_column_content %}


{% block addl_scripts %}
<script>
    $(document).ready(function () {
                      
    var allFieldsets = $('fieldset');
                      
    allFieldsets.each(function() {
        if (!$(this).attr('no-shuffle')) {
            var tmpChoices = $(this).find('label');
            var tmpChoicesCopy = tmpChoices.slice(0); // make copy of jQuery array to manipulate
            $(this).empty();

            while (tmpChoicesCopy.length) {
            var randIdx = Math.floor(Math.random() * tmpChoicesCopy.length);
            var choice = tmpChoicesCopy.splice(randIdx, 1);
            $(this).append(choice);
            }
        }
    });
                      
    $('input[type=submit]').click(function () {
        var userSelections = {};
        $('input').each(function () {
            if (($(this).attr('type') == 'checkbox' || $(this).attr('type') == 'radio') && $(this).get(0).checked == true) {
                if (!userSelections[$(this).attr('name')]) {
                    userSelections[$(this).attr('name')] = [];
                }
                //console.log(userSelections);
                var tmpObj = {};
                tmpObj.value = $(this).attr('value');
                tmpObj.associatedText = $(this).parent().text();

                userSelections[$(this).attr('name')].push(tmpObj);
            } else if (($(this).attr('type') == 'text') && $(this).val() != "") {
                userSelections[$(this).attr('name')] = $(this).val();
            }
        });

        var examXHR = $.post("{% url 'courses.exams.views.collect_data' common_page_data.course.prefix common_page_data.course.suffix exam.slug %}",
               {csrfmiddlewaretoken: "{{ csrf_token }}",
                   json_data:JSON.stringify(userSelections)
               }
        );

        function getDialog() {
            var dialogDiv = $('#dialog-message');
            if (dialogDiv.length == 0) {
                dialogDiv = document.createElement('div');
                $(dialogDiv).attr('id', 'dialog-message');
                $(dialogDiv).append('<p></p>');
                $(document).append($(dialogDiv));
            }
            return dialogDiv;
        }

        examXHR.success(function (evt, xhr, settings) {
            var dialogDiv = getDialog();
            $(dialogDiv).find('p').text(settings.responseText)
            $(dialogDiv).dialog({modal: true});
        });

        examXHR.error(function(xhr, status, msg) {
            var dialogDiv = getDialog();
            $(dialogDiv).find('p').text(msg);
            $(dialogDiv).dialog({modal: true});
        });

    });
                      
    });
</script>
{% endblock addl_scripts %}
