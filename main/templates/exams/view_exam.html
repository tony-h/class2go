{% extends "course_base.html" %}
{% load url from future %}
{% block course_page_title %}{{exam.title}}{% endblock course_page_title %}

{% block m_column_content %}
<div class="alert alert-error" id="nojswarn">
You don't have Javascript enabled or jQuery was not loaded.  This page won't work!  Please re-enable Javascript.
</div>
{% autoescape off %}

{% if common_page_data.course.mode == "ready" and not exam.is_live %}

    This exam will go live on {{ exam.live_datetime }} PDT.

{% elif common_page_data.course.mode == "ready" and exam.past_due %}

    This exam was closed on {{ exam.due_date }} PDT.

{% else %}

    <noscript>
    <div class="alert alert-error">Your browser does not have JavaScript enabled. Please enable it before taking this exam</div>
    </noscript>
    {{ exam.html_content }}

{% endif %}

{% endautoescape %}
{% endblock m_column_content %}




{% block addl_scripts %}
<script>
    $(document).ready(function () {
                      
    $('#nojswarn').remove();
                      
    var allFieldsets = $('fieldset');
                      
    /*
    var testDataObj = {};
    testDataObj.q12c = [];
    testDataObj.q12c[0] = {'value':'b'};
    testDataObj.q15d = [];
    testDataObj.q15d[0] = {'value':'c'};
    testDataObj.q15d[1] = {'value':'d'};
    testDataObj.q15e = 'goodbye';
    window.testData = JSON.stringify(testDataObj);
    */

    window.repopulateForm = function (jsonStr) {
        // first wipe all inputs
        $('input[type|="text"]').val('');
        //$('textarea').text('');
        $('input[type|="checkbox"]').removeAttr('checked');
        $('input[type|="radio"]').removeAttr('checked');

        // just wiped all data 
        if (!jsonStr) {
            return;
        }

        // all keys will be form input names as strings
        var dataObj = JSON.parse(jsonStr);

        // iterate through named form inputs
        for (member in dataObj) {
            
            if (typeof dataObj[member] == "string") {
                // it's a text input/textarea
                $('input[name|=' + member + ']').val(dataObj[member]);
            } else {
                // it's multiple choice, therefore an array
                $('input[name|=' + member + ']').removeAttr('checked');

                // loop through each choice listed for this input
                for (var i = 0; i < dataObj[member].length; i += 1) {
                    var obj = dataObj[member][i];

                    for (key in obj) {

                        if (key == 'value') {
                            console.log(key + ' is what we want');
                        } else {
                            console.log(key + ' is not a real value');
                        }

                        $('#' + member + '_' + obj[key]).attr('checked', 'checked');
                    }

                }
            } 

        }

        var enabled = ('{{editable}}' == 'True') ? true : false;
        if (!enabled) {
            // disable all inputs
            $('input').attr('disabled','disabled');

            // hide submit button
            var submitBtn = $('input[type|="submit"]');
            submitBtn.hide();

            // Add a "re-enable inputs" button
            var reEnableBtn = document.createElement('input');
            $(reEnableBtn).attr('id', 'reEnableForm');
            $(reEnableBtn).attr('type', 'button');
            $(reEnableBtn).attr('title', 'Click to re-enable answers for re-submission of this exam');
            $(reEnableBtn).val('Click to Re-Enable Answers');
            submitBtn.before($(reEnableBtn));
            $(reEnableBtn).click(function (ev) {
                $('input').removeAttr('disabled');
                submitBtn.show();
            });
        }
    };

    allFieldsets.each(function() {
        if (!$(this).attr('no-shuffle')) {
            var tmpChoices = $(this).find('label');
            var tmpChoicesCopy = tmpChoices.slice(0); // make copy of jQuery array to manipulate
            $(this).empty();

            while (tmpChoicesCopy.length) {
            var randIdx = Math.floor(Math.random() * tmpChoicesCopy.length);
            var choice = tmpChoicesCopy.splice(randIdx, 1);
            $(this).append(choice);
            }
        }
    });
                      
    $('input[type=submit]').click(function () {
        var userSelections = {};
        $('input').each(function () {
            if (($(this).attr('type') == 'checkbox' || $(this).attr('type') == 'radio') && $(this).get(0).checked == true) {
                if (!userSelections[$(this).attr('name')]) {
                    userSelections[$(this).attr('name')] = [];
                }
                //console.log(userSelections);
                var tmpObj = {};
                tmpObj.value = $(this).attr('value');
                tmpObj.associatedText = $(this).parent().text();

                userSelections[$(this).attr('name')].push(tmpObj);
            } else if (($(this).attr('type') == 'text') && $(this).val() != "") {
                userSelections[$(this).attr('name')] = $(this).val();
            }
        });

        window.myData = JSON.stringify(userSelections);

        var examXHR = $.post("{% url 'courses.exams.views.collect_data' common_page_data.course.prefix common_page_data.course.suffix exam.slug %}",
               {csrfmiddlewaretoken: "{{ csrf_token }}",
                   json_data:JSON.stringify(userSelections)
               }
        );
        function getDialog() {
            var dialogDiv = $('#dialog-message');
            if (dialogDiv.length == 0) {
                dialogDiv = document.createElement('div');
                $(dialogDiv).attr('id', 'dialog-message');
                $(dialogDiv).append('<p></p>');
                $(document).append($(dialogDiv));
            }
            return dialogDiv;
        }

        examXHR.success(function (evt, xhr, settings) {
            var dialogDiv = getDialog();
            var dueDateMessage = "\n Please check back after {{exam.due_date|date:'D M d Y'}} for your score."
            $(dialogDiv).find('p').text(settings.responseText + dueDateMessage);
            $(dialogDiv).dialog({ modal: true,
                                  buttons: {
                                    'See My Submissions': function() {
                                     document.location="{% url 'courses.exams.views.view_my_submissions' common_page_data.course.prefix common_page_data.course.suffix exam.slug %}"
                                }}});
        });

        examXHR.error(function(xhr, status, msg) {
            var dialogDiv = getDialog();
            $(dialogDiv).find('p').text(msg);
            $(dialogDiv).dialog({modal: true});
        });

    });
                      
    var prePopData = '{% autoescape off %}{{json_pre_pop}}{% endautoescape %}';
    if (prePopData != '') {
        window.repopulateForm(prePopData);
    }

    });
</script>
{% endblock addl_scripts %}
